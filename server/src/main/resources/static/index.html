<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CYBER OBSERVER // GOD VIEW</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Import Map for Modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
</head>

<body>
    <!-- 3D Scene Container -->
    <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>

    <!-- Scanline Overlay -->
    <div class="scanlines"></div>

    <!-- HUD Layer -->
    <div id="ui-layer">
        <!-- Top Bar -->
        <div class="hud-panel top-bar">
            <div class="title-box">
                <h1 data-i18n="title">赛博视奸 // 上帝视角</h1>
                <small style="color:var(--secondary-color)" data-i18n="subtitle">系统 ALPHA // 监控中</small>
            </div>
            <div class="status-indicator">
                <span id="server-status-text" data-i18n="status_offline">离线</span>
                <div id="server-status-dot" class="status-dot"></div>
                <button id="lang-toggle"
                    style="background:none; border:1px solid var(--primary-color); color:var(--primary-color); font-family:var(--font-mono); margin-left:10px; cursor:pointer;">[EN/CN]</button>
            </div>
        </div>

        <!-- Left Panel: Device List -->
        <div class="hud-panel" style="position: absolute; top: 120px; left: 20px;">
            <div class="device-header">
                <span data-i18n="connected_devices">已连接设备</span>
                <span id="device-count">0</span>
            </div>
            <div id="device-list-container">
                <div style="color: #666; font-style: italic;" data-i18n="scanning">正在扫描网络...</div>
            </div>
        </div>

        <!-- Right Panel: Logs (Placeholder) -->
        <div class="hud-panel"
            style="position: absolute; bottom: 20px; right: 20px; max-width: 400px; text-align: right;">
            <div class="device-header" data-i18n="system_logs">系统日志</div>
            <div id="log-container" style="font-size: 10px; color: #aaa;">
                > System initialized.<br>
                > Waiting for uplink...
            </div>
        </div>
    </div>

    <!-- Main Logic -->
    <script type="module">
        import { initScene, updateDeviceState } from './js/scene.js';

        // --- i18n System ---
        const translations = {
            CN: {
                title: "赛博视奸 // 上帝视角",
                subtitle: "系统 ALPHA // 监控中",
                status_online: "在线",
                status_offline: "离线",
                connected_devices: "已连接设备",
                scanning: "正在扫描网络...",
                system_logs: "系统日志",
                battery: "电量",
                cpu: "处理器",
                mem: "内存",
                app: "应用",
                log_uplink: "链路已建立。",
                log_lost: "连接丢失。",
                log_new_device: "检测到新设备："
            },
            EN: {
                title: "CYBER OBSERVER // GOD VIEW",
                subtitle: "SYSTEM ALPHA // MONITORING",
                status_online: "ONLINE",
                status_offline: "OFFLINE",
                connected_devices: "CONNECTED DEVICES",
                scanning: "Scanning network...",
                system_logs: "SYSTEM LOGS",
                battery: "BATTERY",
                cpu: "CPU",
                mem: "MEM",
                app: "APP",
                log_uplink: "Uplink established.",
                log_lost: "Connection lost.",
                log_new_device: "New Device Detected:"
            }
        };

        let currentLang = 'CN';

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            // Update static elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });

            // Update Status Text manually due to ID
            const statusText = document.getElementById('server-status-text');
            if (statusText.innerText === translations['EN'].status_online || statusText.innerText === translations['CN'].status_online) {
                statusText.innerText = t.status_online;
            } else {
                statusText.innerText = t.status_offline;
            }

            // Re-render device cards if needed (simplified: next update will catch it)
        }

        document.getElementById('lang-toggle').onclick = () => {
            setLanguage(currentLang === 'CN' ? 'EN' : 'CN');
        };


        // 1. Initialize 3D
        initScene(document.getElementById('canvas-container'));

        // 2. Log Utils
        const logContainer = document.getElementById('log-container');
        function sysLog(msgKey, param = "") {
            const t = translations[currentLang];
            const msg = t[msgKey] ? t[msgKey] + " " + param : msgKey + " " + param;
            logContainer.innerHTML += `<br>> ${msg}`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 3. WebSocket Logic
        const ws = new WebSocket("ws://" + window.location.host + "/ws");
        const statusDot = document.getElementById('server-status-dot');
        const statusText = document.getElementById('server-status-text');

        ws.onopen = () => {
            statusText.innerText = translations[currentLang].status_online;
            statusDot.classList.add("active");
            sysLog("log_uplink");

            // Auth
            ws.send(JSON.stringify({
                type: "AUTH",
                payloadJson: JSON.stringify({
                    deviceId: "WEB_DISPLAY_01",
                    name: "GOD_VIEW",
                    type: "SERVER",
                    authKey: "MASTER_KEY"
                })
            }));
        };

        ws.onclose = () => {
            statusText.innerText = translations[currentLang].status_offline;
            statusText.style.color = "var(--alert-color)";
            statusDot.classList.remove("active");
            sysLog("log_lost");
        };

        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.type === "STATUS_UPDATE") {
                    const status = JSON.parse(msg.payloadJson);
                    handleStatusUpdate(status);
                }
            } catch (e) {
                console.error(e);
            }
        };

        function handleStatusUpdate(status) {
            // Update 3D
            updateDeviceState(status);

            // Update UI (Simple DOM manipulation for demo)
            updateDeviceCard(status);
        }

        function updateDeviceCard(status) {
            const container = document.getElementById('device-list-container');
            let card = document.getElementById(`card-${status.deviceId}`);
            const t = translations[currentLang];

            // Calculate bars
            const cpuPercent = (status.cpuLoad * 100).toFixed(1);
            const memPercent = (status.memoryUsage * 100).toFixed(1);

            const html = `
                <div class="device-header">
                    <span>${status.deviceId}</span>
                    <span class="blink">ACV</span>
                </div>
                <div class="metric-row">
                    <span>${t.battery}</span>
                    <span>${(status.batteryLevel * 100).toFixed(0)}%</span>
                </div>
                <div class="metric-row">
                    <span>${t.cpu}</span>
                    <span>${cpuPercent}%</span>
                </div>
                <div class="bar-container"><div class="bar-fill" style="width: ${cpuPercent}%"></div></div>
                <div class="metric-row" style="margin-top:5px;">
                    <span>${t.mem}</span>
                    <span>${memPercent}%</span>
                </div>
                <div class="bar-container"><div class="bar-fill" style="width: ${memPercent}%"></div></div>
                <div class="metric-row" style="margin-top:5px; color: #888;">
                    <span>${t.app}: ${status.activeApp.substring(0, 20)}...</span>
                </div>
            `;

            if (!card) {
                card = document.createElement('div');
                card.id = `card-${status.deviceId}`;
                card.className = "device-card";
                container.appendChild(card);

                // Update Count
                document.getElementById('device-count').innerText = container.children.length;
                sysLog("log_new_device", status.deviceId);

                // Remove placeholder
                const placeholder = Array.from(container.children).find(c => c.getAttribute('data-i18n') === 'scanning');
                if (placeholder) placeholder.remove();
            }

            card.innerHTML = html;
        }
    </script>
</body>

</html>